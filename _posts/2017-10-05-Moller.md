---
layout: post
title: "Future-proofing architecture with Kubernetes on ACS"
author: "Pedro Dias, Alessandro Vozza"
date: 2017-10-05
categories: [Application Services]
color: "blue"
image: "images/2017-10-05-Moller/cars.jpg"
excerpt: Møllergruppen investing in Kubernetes on ACS to future-proof their software architecture
language: [English]
verticals: [Application Services, DevOps]
geolocation: [Europe]
#permalink: /<page-title>.html
---

![MøllerGruppen logo image]({{ site.baseurl }}/images/2017-10-05-Moller/MGLogo.jpg)

# Future-proofing software delivery using Kubernetes on ACS

Harald A. Møller AS (part of the Møller Group) is Norway's largest car importer and has imported Volkswagen AG's car brands since 1948.

They reached out to Microsoft for building a container-based architecture, specifically on Kubernetes, in Azure. Some of the technologies they use on a daily basis are: 
Scala, Node, Ruby, Java. They intended to connect their ACS cluster with on-prem infrastructure through ExpressRoute, and set up a CI/CD pipeline through Jenkins.

This document describes the process. 

## Technologies Used
- [Kubernetes](https://kubernetes.io/), container orchestration
- [Azure Container Services](https://azure.microsoft.com/en-us/services/container-service/), host environment for Kubernetes
- [Docker](https://www.docker.com/), container technology
- [Azure Active Directory](https://azure.microsoft.com/en-us/services/active-directory/), identity management
- [Jenkins](https://jenkins.io/), build/deployment engine
- [Nexus](https://www.sonatype.com/nexus-repository-oss), container repository
- [Azure Command line tools](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest), remote controlling azure
- [HipChat](https://www.stride.com/), chat/collaboration tool

![Old cars at Møllergruppen]({{ site.baseurl }}/images/2017-10-05-Moller/cars.jpg)<br />
**Image:** *Car exhibition at the Møllergruppen offices*

## Goals for the hackfest
In general, Møllergruppens goal is to aquire the know-how to architecting container-based solutions in all new development. We set up a plan to learn as much as possible about: 

- Setting up an ARM Template for deploying Kubernetes on ACS in a new resource group
  - How to create an ACS-E Template, and modify it to suit our needs
  - Use the ACS-E Template to create an ARM template for infrastructure generation in Azure
- Set up automated deployment in a CI/CD Pipeline through Jenkins
- Set up role-based access to Kubernetes
- Learn, and get more hands-on experience with Azure

--- 

## Hackfest participants

Møllergruppen came well prepared with a team of software architects, DevOps managers, and operations, making it possible for us to hit the ground running and get down to the tech allmost immediately. The teams from Microsoft and Møllergruppen were: 

| Person           		| Role                         | 
| -----------------		| -----------------------------| 
| Alessandro Vozza 		| Microsoft, Kubernetes expert | 
| Pedro Dias       		| Microsoft, observer          |
| Jon Marius Håkedal 	| Lead Software Architect      | 
| Christian Chavez 		| DevOps                       | 
| Vebjørn Svare    		| IT Operations                | 
| Jørgen Nyen-Pedersen  | Architecture                 |
| Anders Nordby         | It Operations                |

## Hit the ground running
After a brief round of introduction, Alessandro did a short introduction to Kubernetes to bring everyone present up to speed. 
After the intro, we set up an agenda for work, and followed it through during our 2-day hack.

>**Resource group discussion** <br/>
>During the hackfest, we discussed how to manage cost-control over the different teams and their use of Kubernetes. 
>Møllergruppen initially thought of having one Kubernetes cluster per team, but quickly dismissed it as the whole idea
>behind Kubernetes is the ability to access named services. We ended up on having one Resource Group for dev/testing, 
>and one production group. Møllergruppen will then split the cost of their dev environment by the teams. 

## Day 1 summary
Filled out a partial ACS-E template, filled it out with local values
Have a running cluster with 1 master and 2 slaves. 

**Issues**<br />
A firewall prevented the creation of a VPN tunnel to the Kubernetes cluster from Møllergruppen, but was fixed prior to day 2 engagement.

We also tried to remove public access to the cluster, and reached a semi-working solution but left us without a proper way to connect to the cluster. 


## Day 2 summary
- Set up a CI/CD Pipeline 
- Deployed a Kubernetes cluster with AAD and RBAC
- Helped deploying Nexus as artifact repository and docker registry

---

## Technical details of the work delivered

The goal of the hackfest was to learn and share the knowledge on how modern container orchestration platform, and in particular Kubernetes can help modernize the application landscape at Møllergruppens and enable digital transformation of their business.

![Hackers and coffee]({{ site.baseurl }}/images/2017-10-05-Moller/hackersAndCoffee.jpg)<br />
**Image:** *The team deeply engaged in getting stuff done*


### ACS Engine Installation
The Azure Container Service Engine (acs-engine) generates ARM (Azure Resource Manager) templates for Docker enabled clusters on Microsoft Azure with your choice of DC/OS, Kubernetes, Swarm Mode, or Swarm orchestrators. The input to the tool is a cluster definition. The cluster definition is very similar to (in many cases the same as) the ARM template syntax used to deploy a Microsoft Azure Container Service cluster.

#### Instructions 
Please follow the instructions on the official [Github](https://github.com/Azure/acs-engine/blob/master/docs/acsengine.md) repository. We installed it as a Docker container on windows, under the Windows Subsystem for Linux (WSL).

### Creating an ACS-E Template
An acs-engine template is a JSON template that is processed to generate ARM templates to deploy popular container orchestration frameworks like Mesosphere and Swarm. We set ourselves up to create a template to deploy a Kubernetes cluster with the required amount of masters, nodes and specific features enabled (namely, AAD support, custom vNet integration and RBAC support).

#### Instructions
An example of a template used to generate an RBAC/AAD enabled cluster can be found [here](https://gist.github.com/ams0/c028ef6900fd7d6b49c8889c684ef11c).


### Genereated the ARM Templates
The ACS Engine runs locally on your machine or on the cloud shell. 
Once installed, you run it to produce the ARM Templates that will 
set up the necessary infrastructure required by Kubernetes. 

#### Instructions
With a properly formatted acs-engine template, the generation of the ARM templates can be performed with the following command:

```
acs-engine generate template.json
```


### Deploying the ARM template to Azure
In the specific case, a Resource Group was pre-existent in the Azure infrastructure, which also contains the peered vNet and the Azure VPN Gateway, so we will target it without touching the existing resources. 

### Instructions

The generated templates are regular ARM templates that can be deployed in a resource group in Azure, using standard Azure CLI commands:

```
az group deployment create -n <name> -g <rg> \
--template-file _output/<folder>/azuredeploy.json \
--parameters @_output/<folder>/azuredeploy.parameters.json
```

### Enabling role-based access to Kubernetes

We wanted to set up role-based access to Kubernetes to manage who has access in tight integration with Møllergruppen's AD. 
To do this, we closely followed this instructions:
https://github.com/Azure/acs-engine/blob/master/docs/kubernetes/aad.md

### Setting up a CI/CD Pipeline through Jenkins and Sonatype Nexus
The goal was to deploy a CI/CD pipeline into the existing Jenkins instance (running on premise) to deploy applications, built and stored as Docker containers in Nexus (a popular artifact storage system that doubles as docker registry) to the newly deployed Kubernetes cluster. Unfortunately, due to time constraints, we could only show a demo pipeline (available on Github [here](https://github.com/ams0/croc-hunter/blob/master/Jenkinsfile)) as a Jenkins declarative pipeline). We did support Møllergruppen with the effort of deploying a containerized (with persisten storage as attached block storage) Nexus instance into a VM deployed in the same resource group as Kubernetes (so it can be reached from on-premise Jenkins).


#### Instructions
Please follow the instructions for the demo pipeline [here](https://github.com/lachie83/croc-hunter/blob/master/DEMO.md).

---

## Conclusion

![Developers in debate]({{ site.baseurl }}/images/2017-10-05-Moller/deepfocus.jpg)<br />
**Image:** *Microsoft and Møllergruppen debating solutions*

## Going forward
When the ideas and concepts of Kubernetes will be assimilated and internalized by the team at Møllergruppen, we will re-engage to complete and extend the engagement with properly setup delivery pipeline. One major requirement that we were not able to meet during the hackfest, was to deploy a fully isolated (that is, without public load balancers but instead with Azure Internal Loadbalancers, ILB). We set aside the goal in lieu of the limited time, but we already found out possible obstacles in the form of proper certificate generation (acs-engine generates certificates for the *.region.cloudapp.azure.com domain, while customers might need a certificate belonging to their own domain) and API access thru the ExpressRoute/VPN Gateway.




## Useful Links

Kubernetes on Azure: <br />
[https://azure.microsoft.com/en-us/services/container-service/](https://azure.microsoft.com/en-us/services/container-service/)

Inside Microsoft DataCenter, Hardware and software<br />
[https://www.youtube.com/watch?v=Lv8fDiTNHjk&t=2s](https://www.youtube.com/watch?v=Lv8fDiTNHjk&t=2s)

Azure Container Service Engine on Github<br />
[https://github.com/azure/acs-engine](https://github.com/azure/acs-engine) 

How to install azure command line tools<br />
[https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest)

Getting Azure Auto-complete for the command line tools<br />
[https://github.com/Azure/azure-cli/blob/master/src/azure-cli/az.completion.sh](https://github.com/Azure/azure-cli/blob/master/src/azure-cli/az.completion.sh)

Install Kubectl tool using Curl<br />
[https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-binary-via-curl](https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-binary-via-curl)


---

<center>
.end of document.
</center>
